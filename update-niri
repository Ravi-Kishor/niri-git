#!/usr/bin/env bash
set -euo pipefail

REPO="Ravi-Kishor/niri-git"
PKG_NAME="niri-git"
ARCH_PATTERN="x86_64_v3.pkg.tar.zst"

AUTO_YES=false
FORCE=false

# -------------------------------
# Parse Arguments
# -------------------------------
for arg in "$@"; do
  case "$arg" in
    -y|--yes) AUTO_YES=true ;;
    -f|--force) FORCE=true ;;
  esac
done

# -------------------------------
# Dependency Check
# -------------------------------
require() {
  command -v "$1" >/dev/null 2>&1 || {
    echo "‚ùå Required command '$1' not found"
    exit 1
  }
}

for cmd in curl jq pacman sudo aria2c vercmp; do
  require "$cmd"
done

# -------------------------------
# Get Installed Version
# -------------------------------
get_installed_version() {
  pacman -Q "$PKG_NAME" 2>/dev/null | awk '{print $2}' || true
}

INSTALLED_VERSION="$(get_installed_version)"

echo "Installed version: ${INSTALLED_VERSION:-Not Installed}"
echo "üì° Fetching latest release..."

# -------------------------------
# Fetch Latest Release
# -------------------------------
RELEASE_JSON="$(curl -fsSL "https://api.github.com/repos/$REPO/releases/latest")"

echo "$RELEASE_JSON" | jq -e . >/dev/null || {
  echo "‚ùå Invalid GitHub API response"
  exit 1
}

ASSET_URL="$(echo "$RELEASE_JSON" | jq -r \
  ".assets[] | select(.name | contains(\"$ARCH_PATTERN\")) | .browser_download_url" \
  | head -n1)"

if [[ -z "$ASSET_URL" || "$ASSET_URL" == "null" ]]; then
  echo "‚ùå No matching package found in release"
  exit 1
fi

PKG_FILE="$(basename "$ASSET_URL")"

LATEST_VERSION="$(echo "$PKG_FILE" | sed -E \
  "s/^${PKG_NAME}-(.*)-${ARCH_PATTERN}/\1/")"

echo "Latest version: $LATEST_VERSION"
echo

# -------------------------------
# Compare Versions
# -------------------------------
UP_TO_DATE=false
if [[ -n "${INSTALLED_VERSION:-}" ]]; then
  if [[ "$(vercmp "$INSTALLED_VERSION" "$LATEST_VERSION")" -ge 0 ]]; then
    UP_TO_DATE=true
  fi
fi

# -------------------------------
# Interactive Menu
# -------------------------------
if [[ "$AUTO_YES" = false && "$FORCE" = false ]]; then
  echo "Choose an action:"
  echo "1) Update (skip if already latest)"
  echo "2) Force reinstall"
  echo "3) Cancel"
  read -rp "Enter choice (1/2/3): " CHOICE

  case "$CHOICE" in
    1) ;;
    2) FORCE=true ;;
    *) echo "Cancelled."; exit 0 ;;
  esac
fi

if [[ "$UP_TO_DATE" = true && "$FORCE" = false ]]; then
  echo "‚úÖ Already up to date."
  exit 0
fi

echo "Preparing installation..."

# -------------------------------
# Remove Conflicting Packages Safely
# -------------------------------
remove_if_installed() {
  if pacman -Qq "$1" >/dev/null 2>&1; then
    echo "Removing conflicting package: $1"
    sudo pacman -Rns --noconfirm "$1" 2>/dev/null || true
  fi
}

remove_if_installed niri
remove_if_installed niri-v3

# -------------------------------
# Download + Install
# -------------------------------
TMP_DIR="$(mktemp -d)"
trap 'rm -rf "$TMP_DIR"' EXIT

cd "$TMP_DIR"

echo "‚¨áÔ∏è Downloading package..."
aria2c -x 8 -s 8 -k 1M -o "$PKG_FILE" "$ASSET_URL"

echo "üì¶ Installing..."
sudo pacman -U --noconfirm "$PKG_FILE"

echo
echo "‚úÖ $PKG_NAME $LATEST_VERSION installed successfully."
