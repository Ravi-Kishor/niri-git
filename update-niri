#!/bin/bash
set -euo pipefail

REPO="Ravi-Kishor/niri-git"
PKG_NAME="niri-git"

AUTO_YES=false
FORCE=false

for arg in "$@"; do
  case "$arg" in
    -y|--yes) AUTO_YES=true ;;
    -f|--force) FORCE=true ;;
  esac
done

require() {
  command -v "$1" >/dev/null 2>&1 || {
    echo "❌ Required command '$1' not found"
    exit 1
  }
}

require curl
require jq
require pacman
require sudo
require aria2c
require vercmp

get_installed_version() {
  pacman -Q "$PKG_NAME" 2>/dev/null | awk '{print $2}' || echo ""
}

INSTALLED_VERSION=$(get_installed_version)

echo "Installed version: ${INSTALLED_VERSION:-Not Installed}"
echo "Fetching latest release..."

RELEASE_JSON=$(curl -fsSL "https://api.github.com/repos/$REPO/releases/latest")

# Validate GitHub response
if ! echo "$RELEASE_JSON" | jq -e . >/dev/null 2>&1; then
  echo "❌ Failed to parse GitHub API response."
  exit 1
fi

ASSET_URL=$(echo "$RELEASE_JSON" | jq -r '
  .assets[]
  | select(.name | contains("x86_64_v3.pkg.tar.zst"))
  | .browser_download_url
' | head -n1)

if [[ -z "$ASSET_URL" || "$ASSET_URL" == "null" ]]; then
  echo "❌ No x86_64_v3 package found in latest release."
  exit 1
fi

PKG_FILE=$(basename "$ASSET_URL")

LATEST_VERSION=$(echo "$PKG_FILE" | sed -E \
  's/^niri-git-(.*)-x86_64_v3\.pkg\.tar\.zst/\1/')

echo "Latest version: $LATEST_VERSION"

# Version comparison
if [[ -n "$INSTALLED_VERSION" && "$FORCE" = false ]]; then
  if [[ "$(vercmp "$INSTALLED_VERSION" "$LATEST_VERSION")" -ge 0 ]]; then
    echo "Already up to date."
    exit 0
  fi
fi

# Confirmation only if installed and not auto mode
if [[ "$AUTO_YES" = false ]]; then
  if [[ -n "$INSTALLED_VERSION" ]]; then
    read -rp "Update niri-git to $LATEST_VERSION? [y/N]: " CONFIRM
    [[ "$CONFIRM" =~ ^[Yy]$ ]] || exit 0
  else
    read -rp "Install niri-git $LATEST_VERSION? [y/N]: " CONFIRM
    [[ "$CONFIRM" =~ ^[Yy]$ ]] || exit 0
  fi
fi

echo "Preparing installation..."

# Remove conflicting packages
for pkg in niri niri-v3; do
  if pacman -Q "$pkg" >/dev/null 2>&1; then
    echo "Removing conflicting package: $pkg"
    sudo pacman -R --noconfirm "$pkg"
  fi
done

TMP_DIR=$(mktemp -d)
cd "$TMP_DIR"

echo "Downloading..."
aria2c -x 8 -s 8 -k 1M -o "$PKG_FILE" "$ASSET_URL"

echo "Installing..."
sudo pacman -U --noconfirm "$PKG_FILE"

cd /
rm -rf "$TMP_DIR"

echo "✅ niri-git $LATEST_VERSION installed successfully."
